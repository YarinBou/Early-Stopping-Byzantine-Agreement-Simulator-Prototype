<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>JSON Serialization with Canonical Ordering</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.3-json-serialization-with-canonical-ordering.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a protocol developer</asA>
    <iWant>deterministic JSON serialization for messages</iWant>
    <soThat>identical messages produce identical serialized bytes for cryptographic hashing and signatures</soThat>
    <tasks>
      <task id="1">Create serialization.py module with MessageSerializer class</task>
      <task id="2">Implement encode(message: Message) -> bytes method using JSON with canonical key ordering</task>
      <task id="3">Implement base64 encoding for binary fields (signature, digest)</task>
      <task id="4">Implement decode(data: bytes) -> Message method</task>
      <task id="5">Ensure round-trip compatibility: decode(encode(msg)) == msg</task>
      <task id="6">Verify deterministic output for identical messages</task>
      <task id="7">Design abstraction layer for future CBOR migration</task>
      <task id="8">Write comprehensive unit tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Create serialization.py module with MessageSerializer class</criterion>
    <criterion id="2">encode(message: Message) -> bytes method using JSON with canonical key ordering (sort_keys=True)</criterion>
    <criterion id="3">Binary fields (signature, digest) base64-encoded for JSON compatibility</criterion>
    <criterion id="4">decode(data: bytes) -> Message method reconstructing Message objects</criterion>
    <criterion id="5">Round-trip test: decode(encode(msg)) == msg for all message types</criterion>
    <criterion id="6">Deterministic output: same message always produces identical bytes</criterion>
    <criterion id="7">Abstraction layer designed for future CBOR migration (encode/decode interface only)</criterion>
    <criterion id="8">Unit tests covering: encoding, decoding, determinism, base64 handling, error cases</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification - Foundation Infrastructure</title>
        <section>MessageSerializer Interface</section>
        <snippet>Abstract interface for message serialization enabling future migration from JSON to CBOR. JSONMessageSerializer uses json.dumps with sort_keys=True and base64 for binary fields.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Data Models - Message Dataclass</section>
        <snippet>Message dataclass with signing_payload() method that excludes signature field and uses canonical JSON with sorted keys for deterministic byte output.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Project Architecture</title>
        <section>Complete Project Structure - transport module</section>
        <snippet>src/ba_simulator/transport/serialization.py implements MessageSerializer interface with JSON implementation for deterministic message serialization.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Test Strategy - Serialization Tests</section>
        <snippet>Test encode produces deterministic bytes (same message → same output), round-trip decode(encode(msg)) == msg, base64 encoding for binary fields, and malformed JSON handling.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/ba_simulator/transport/message.py</path>
        <kind>dataclass</kind>
        <symbol>Message</symbol>
        <lines>19-180</lines>
        <reason>Existing Message dataclass that serialization must support. Contains to_dict() and signing_payload() methods that use JSON serialization. Binary fields (signature, digest) need base64 encoding.</reason>
      </artifact>
      <artifact>
        <path>src/ba_simulator/transport/message.py</path>
        <kind>method</kind>
        <symbol>Message.to_dict()</symbol>
        <lines>109-133</lines>
        <reason>Returns dictionary representation for serialization. Note: Binary fields returned as bytes - serializer must handle base64 encoding.</reason>
      </artifact>
      <artifact>
        <path>src/ba_simulator/transport/message.py</path>
        <kind>method</kind>
        <symbol>Message.signing_payload()</symbol>
        <lines>135-180</lines>
        <reason>Already implements canonical JSON serialization with sort_keys=True for signing. Shows pattern to follow: sorted keys, no whitespace, UTF-8 encoding. Converts digest bytes to hex.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/transport/test_message.py</path>
        <kind>test</kind>
        <symbol>test_message</symbol>
        <lines>all</lines>
        <reason>Existing Message tests - provides examples of Message creation and validation patterns to follow in serialization tests.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="json" version="stdlib">Standard library - json.dumps with sort_keys=True for canonical ordering</package>
        <package name="base64" version="stdlib">Standard library - b64encode/b64decode for binary field encoding</package>
        <package name="pytest" version="7.4.3">Testing framework for unit tests</package>
        <package name="pytest-cov" version="4.1.0">Test coverage reporting</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Module must be created at: src/ba_simulator/transport/serialization.py</constraint>
    <constraint>Follow snake_case for module names, PascalCase for class names per architecture conventions</constraint>
    <constraint>Use ABC (Abstract Base Class) pattern for MessageSerializer interface to enable future CBOR migration</constraint>
    <constraint>JSON encoding MUST use sort_keys=True for deterministic canonical ordering</constraint>
    <constraint>Binary fields (signature, digest) MUST be base64-encoded before JSON serialization</constraint>
    <constraint>JSON output must use separators=(',', ':') for compact representation (no whitespace)</constraint>
    <constraint>UTF-8 encoding for all byte conversions</constraint>
    <constraint>Round-trip requirement: decode(encode(msg)) must equal original message</constraint>
    <constraint>Determinism requirement: same message always produces identical bytes</constraint>
    <constraint>Test coverage target: ≥80% line coverage per Epic 1 acceptance criteria</constraint>
    <constraint>Use pytest for all unit tests, follow existing test structure in tests/unit/transport/</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>MessageSerializer (Abstract Base Class)</name>
      <kind>Abstract class interface</kind>
      <signature>
class MessageSerializer(ABC):
    @abstractmethod
    def encode(self, message: Message) -> bytes:
        """Serializes message to bytes with deterministic ordering."""
        pass

    @abstractmethod
    def decode(self, data: bytes) -> Message:
        """Deserializes bytes to Message object."""
        pass
      </signature>
      <path>src/ba_simulator/transport/serialization.py</path>
    </interface>
    <interface>
      <name>JSONMessageSerializer (Concrete Implementation)</name>
      <kind>Class implementing MessageSerializer</kind>
      <signature>
class JSONMessageSerializer(MessageSerializer):
    def encode(self, message: Message) -> bytes:
        """Uses json.dumps with sort_keys=True, base64 for binary fields."""
        # Convert to dict, encode binary fields, JSON stringify

    def decode(self, data: bytes) -> Message:
        """Parses JSON, decodes base64 binary fields, reconstructs Message."""
        # JSON parse, decode base64, create Message object
      </signature>
      <path>src/ba_simulator/transport/serialization.py</path>
    </interface>
    <interface>
      <name>Message.to_dict()</name>
      <kind>Method</kind>
      <signature>def to_dict(self) -> Dict[str, Any]</signature>
      <path>src/ba_simulator/transport/message.py:109-133</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Use pytest framework (version 7.4.3) for all unit tests. Tests should follow existing patterns in tests/unit/transport/test_message.py.
      Coverage target ≥80% measured with pytest-cov. Test file naming: test_serialization.py in tests/unit/transport/.
      Follow 3-section test structure: Arrange (setup), Act (execute), Assert (verify). Use descriptive test names: test_<feature>_<scenario>_<expected>.
      Test both happy path and error cases. Use pytest fixtures for common test data setup.
    </standards>
    <locations>
      <location>tests/unit/transport/test_serialization.py</location>
      <location>tests/unit/transport/ (general unit tests for transport module)</location>
    </locations>
    <ideas>
      <idea ac="2">Test encode() produces deterministic bytes: create same message twice, encode both, assert bytes identical</idea>
      <idea ac="2">Test canonical key ordering: verify JSON output has sorted keys (inspect serialized string)</idea>
      <idea ac="3">Test base64 encoding for signature field: encode message with binary signature, verify JSON contains base64 string</idea>
      <idea ac="3">Test base64 encoding for digest field: encode message with binary digest, verify proper base64 representation</idea>
      <idea ac="4">Test decode() reconstructs Message: encode message, decode result, verify all fields match original</idea>
      <idea ac="5">Test round-trip equality: decode(encode(msg)) == msg for various message types (different protocols, phases, values)</idea>
      <idea ac="6">Test deterministic output: encode same message multiple times, all outputs identical</idea>
      <idea ac="7">Test MessageSerializer abstraction: verify abstract base class can't be instantiated directly</idea>
      <idea ac="8">Test error handling: malformed JSON input to decode() raises appropriate exception</idea>
      <idea ac="8">Test error handling: invalid base64 in binary fields raises exception during decode()</idea>
      <idea ac="8">Test edge cases: empty aux dict, None digest, various value types (string, int, dict, list)</idea>
    </ideas>
  </tests>
</story-context>
